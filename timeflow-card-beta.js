function e(e,t,i,s){var r,n=arguments.length,a=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;o>=0;o--)(r=e[o])&&(a=(n<3?r(a):n>3?r(t,i,a):r(t,i))||a);return n>3&&a&&Object.defineProperty(t,i,a),a}"function"==typeof SuppressedError&&SuppressedError;const t=globalThis,i=t.ShadowRoot&&(void 0===t.ShadyCSS||t.ShadyCSS.nativeShadow)&&"adoptedStyleSheets"in Document.prototype&&"replace"in CSSStyleSheet.prototype,s=Symbol(),r=new WeakMap;let n=class{constructor(e,t,i){if(this._$cssResult$=!0,i!==s)throw Error("CSSResult is not constructable. Use `unsafeCSS` or `css` instead.");this.cssText=e,this.t=t}get styleSheet(){let e=this.o;const t=this.t;if(i&&void 0===e){const i=void 0!==t&&1===t.length;i&&(e=r.get(t)),void 0===e&&((this.o=e=new CSSStyleSheet).replaceSync(this.cssText),i&&r.set(t,e))}return e}toString(){return this.cssText}};const a=(e,...t)=>{const i=1===e.length?e[0]:t.reduce((t,i,s)=>t+(e=>{if(!0===e._$cssResult$)return e.cssText;if("number"==typeof e)return e;throw Error("Value passed to 'css' function must be a 'css' function result: "+e+". Use 'unsafeCSS' to pass non-literal values, but take care to ensure page security.")})(i)+e[s+1],e[0]);return new n(i,e,s)},o=i?e=>e:e=>e instanceof CSSStyleSheet?(e=>{let t="";for(const i of e.cssRules)t+=i.cssText;return(e=>new n("string"==typeof e?e:e+"",void 0,s))(t)})(e):e,{is:l,defineProperty:c,getOwnPropertyDescriptor:d,getOwnPropertyNames:h,getOwnPropertySymbols:u,getPrototypeOf:m}=Object,p=globalThis,g=p.trustedTypes,f=g?g.emptyScript:"",_=p.reactiveElementPolyfillSupport,v=(e,t)=>e,y={toAttribute(e,t){switch(t){case Boolean:e=e?f:null;break;case Object:case Array:e=null==e?e:JSON.stringify(e)}return e},fromAttribute(e,t){let i=e;switch(t){case Boolean:i=null!==e;break;case Number:i=null===e?null:Number(e);break;case Object:case Array:try{i=JSON.parse(e)}catch(e){i=null}}return i}},$=(e,t)=>!l(e,t),b={attribute:!0,type:String,converter:y,reflect:!1,useDefault:!1,hasChanged:$};Symbol.metadata??=Symbol("metadata"),p.litPropertyMetadata??=new WeakMap;let T=class extends HTMLElement{static addInitializer(e){this._$Ei(),(this.l??=[]).push(e)}static get observedAttributes(){return this.finalize(),this._$Eh&&[...this._$Eh.keys()]}static createProperty(e,t=b){if(t.state&&(t.attribute=!1),this._$Ei(),this.prototype.hasOwnProperty(e)&&((t=Object.create(t)).wrapped=!0),this.elementProperties.set(e,t),!t.noAccessor){const i=Symbol(),s=this.getPropertyDescriptor(e,i,t);void 0!==s&&c(this.prototype,e,s)}}static getPropertyDescriptor(e,t,i){const{get:s,set:r}=d(this.prototype,e)??{get(){return this[t]},set(e){this[t]=e}};return{get:s,set(t){const n=s?.call(this);r?.call(this,t),this.requestUpdate(e,n,i)},configurable:!0,enumerable:!0}}static getPropertyOptions(e){return this.elementProperties.get(e)??b}static _$Ei(){if(this.hasOwnProperty(v("elementProperties")))return;const e=m(this);e.finalize(),void 0!==e.l&&(this.l=[...e.l]),this.elementProperties=new Map(e.elementProperties)}static finalize(){if(this.hasOwnProperty(v("finalized")))return;if(this.finalized=!0,this._$Ei(),this.hasOwnProperty(v("properties"))){const e=this.properties,t=[...h(e),...u(e)];for(const i of t)this.createProperty(i,e[i])}const e=this[Symbol.metadata];if(null!==e){const t=litPropertyMetadata.get(e);if(void 0!==t)for(const[e,i]of t)this.elementProperties.set(e,i)}this._$Eh=new Map;for(const[t,i]of this.elementProperties){const e=this._$Eu(t,i);void 0!==e&&this._$Eh.set(e,t)}this.elementStyles=this.finalizeStyles(this.styles)}static finalizeStyles(e){const t=[];if(Array.isArray(e)){const i=new Set(e.flat(1/0).reverse());for(const e of i)t.unshift(o(e))}else void 0!==e&&t.push(o(e));return t}static _$Eu(e,t){const i=t.attribute;return!1===i?void 0:"string"==typeof i?i:"string"==typeof e?e.toLowerCase():void 0}constructor(){super(),this._$Ep=void 0,this.isUpdatePending=!1,this.hasUpdated=!1,this._$Em=null,this._$Ev()}_$Ev(){this._$ES=new Promise(e=>this.enableUpdating=e),this._$AL=new Map,this._$E_(),this.requestUpdate(),this.constructor.l?.forEach(e=>e(this))}addController(e){(this._$EO??=new Set).add(e),void 0!==this.renderRoot&&this.isConnected&&e.hostConnected?.()}removeController(e){this._$EO?.delete(e)}_$E_(){const e=new Map,t=this.constructor.elementProperties;for(const i of t.keys())this.hasOwnProperty(i)&&(e.set(i,this[i]),delete this[i]);e.size>0&&(this._$Ep=e)}createRenderRoot(){const e=this.shadowRoot??this.attachShadow(this.constructor.shadowRootOptions);return((e,s)=>{if(i)e.adoptedStyleSheets=s.map(e=>e instanceof CSSStyleSheet?e:e.styleSheet);else for(const i of s){const s=document.createElement("style"),r=t.litNonce;void 0!==r&&s.setAttribute("nonce",r),s.textContent=i.cssText,e.appendChild(s)}})(e,this.constructor.elementStyles),e}connectedCallback(){this.renderRoot??=this.createRenderRoot(),this.enableUpdating(!0),this._$EO?.forEach(e=>e.hostConnected?.())}enableUpdating(e){}disconnectedCallback(){this._$EO?.forEach(e=>e.hostDisconnected?.())}attributeChangedCallback(e,t,i){this._$AK(e,i)}_$ET(e,t){const i=this.constructor.elementProperties.get(e),s=this.constructor._$Eu(e,i);if(void 0!==s&&!0===i.reflect){const r=(void 0!==i.converter?.toAttribute?i.converter:y).toAttribute(t,i.type);this._$Em=e,null==r?this.removeAttribute(s):this.setAttribute(s,r),this._$Em=null}}_$AK(e,t){const i=this.constructor,s=i._$Eh.get(e);if(void 0!==s&&this._$Em!==s){const e=i.getPropertyOptions(s),r="function"==typeof e.converter?{fromAttribute:e.converter}:void 0!==e.converter?.fromAttribute?e.converter:y;this._$Em=s;const n=r.fromAttribute(t,e.type);this[s]=n??this._$Ej?.get(s)??n,this._$Em=null}}requestUpdate(e,t,i){if(void 0!==e){const s=this.constructor,r=this[e];if(i??=s.getPropertyOptions(e),!((i.hasChanged??$)(r,t)||i.useDefault&&i.reflect&&r===this._$Ej?.get(e)&&!this.hasAttribute(s._$Eu(e,i))))return;this.C(e,t,i)}!1===this.isUpdatePending&&(this._$ES=this._$EP())}C(e,t,{useDefault:i,reflect:s,wrapped:r},n){i&&!(this._$Ej??=new Map).has(e)&&(this._$Ej.set(e,n??t??this[e]),!0!==r||void 0!==n)||(this._$AL.has(e)||(this.hasUpdated||i||(t=void 0),this._$AL.set(e,t)),!0===s&&this._$Em!==e&&(this._$Eq??=new Set).add(e))}async _$EP(){this.isUpdatePending=!0;try{await this._$ES}catch(e){Promise.reject(e)}const e=this.scheduleUpdate();return null!=e&&await e,!this.isUpdatePending}scheduleUpdate(){return this.performUpdate()}performUpdate(){if(!this.isUpdatePending)return;if(!this.hasUpdated){if(this.renderRoot??=this.createRenderRoot(),this._$Ep){for(const[e,t]of this._$Ep)this[e]=t;this._$Ep=void 0}const e=this.constructor.elementProperties;if(e.size>0)for(const[t,i]of e){const{wrapped:e}=i,s=this[t];!0!==e||this._$AL.has(t)||void 0===s||this.C(t,void 0,i,s)}}let e=!1;const t=this._$AL;try{e=this.shouldUpdate(t),e?(this.willUpdate(t),this._$EO?.forEach(e=>e.hostUpdate?.()),this.update(t)):this._$EM()}catch(t){throw e=!1,this._$EM(),t}e&&this._$AE(t)}willUpdate(e){}_$AE(e){this._$EO?.forEach(e=>e.hostUpdated?.()),this.hasUpdated||(this.hasUpdated=!0,this.firstUpdated(e)),this.updated(e)}_$EM(){this._$AL=new Map,this.isUpdatePending=!1}get updateComplete(){return this.getUpdateComplete()}getUpdateComplete(){return this._$ES}shouldUpdate(e){return!0}update(e){this._$Eq&&=this._$Eq.forEach(e=>this._$ET(e,this[e])),this._$EM()}updated(e){}firstUpdated(e){}};T.elementStyles=[],T.shadowRootOptions={mode:"open"},T[v("elementProperties")]=new Map,T[v("finalized")]=new Map,_?.({ReactiveElement:T}),(p.reactiveElementVersions??=[]).push("2.1.1");const w=globalThis,x=w.trustedTypes,S=x?x.createPolicy("lit-html",{createHTML:e=>e}):void 0,A="$lit$",C=`lit$${Math.random().toFixed(9).slice(2)}$`,D="?"+C,I=`<${D}>`,E=document,M=()=>E.createComment(""),N=e=>null===e||"object"!=typeof e&&"function"!=typeof e,k=Array.isArray,R="[ \t\n\f\r]",P=/<(?:(!--|\/[^a-zA-Z])|(\/?[a-zA-Z][^>\s]*)|(\/?$))/g,O=/-->/g,U=/>/g,L=RegExp(`>|${R}(?:([^\\s"'>=/]+)(${R}*=${R}*(?:[^ \t\n\f\r"'\`<>=]|("|')|))|$)`,"g"),z=/'/g,H=/"/g,F=/^(?:script|style|textarea|title)$/i,V=(e=>(t,...i)=>({_$litType$:e,strings:t,values:i}))(1),W=Symbol.for("lit-noChange"),j=Symbol.for("lit-nothing"),G=new WeakMap,q=E.createTreeWalker(E,129);function B(e,t){if(!k(e)||!e.hasOwnProperty("raw"))throw Error("invalid template strings array");return void 0!==S?S.createHTML(t):t}const J=(e,t)=>{const i=e.length-1,s=[];let r,n=2===t?"<svg>":3===t?"<math>":"",a=P;for(let o=0;o<i;o++){const t=e[o];let i,l,c=-1,d=0;for(;d<t.length&&(a.lastIndex=d,l=a.exec(t),null!==l);)d=a.lastIndex,a===P?"!--"===l[1]?a=O:void 0!==l[1]?a=U:void 0!==l[2]?(F.test(l[2])&&(r=RegExp("</"+l[2],"g")),a=L):void 0!==l[3]&&(a=L):a===L?">"===l[0]?(a=r??P,c=-1):void 0===l[1]?c=-2:(c=a.lastIndex-l[2].length,i=l[1],a=void 0===l[3]?L:'"'===l[3]?H:z):a===H||a===z?a=L:a===O||a===U?a=P:(a=L,r=void 0);const h=a===L&&e[o+1].startsWith("/>")?" ":"";n+=a===P?t+I:c>=0?(s.push(i),t.slice(0,c)+A+t.slice(c)+C+h):t+C+(-2===c?o:h)}return[B(e,n+(e[i]||"<?>")+(2===t?"</svg>":3===t?"</math>":"")),s]};class K{constructor({strings:e,_$litType$:t},i){let s;this.parts=[];let r=0,n=0;const a=e.length-1,o=this.parts,[l,c]=J(e,t);if(this.el=K.createElement(l,i),q.currentNode=this.el.content,2===t||3===t){const e=this.el.content.firstChild;e.replaceWith(...e.childNodes)}for(;null!==(s=q.nextNode())&&o.length<a;){if(1===s.nodeType){if(s.hasAttributes())for(const e of s.getAttributeNames())if(e.endsWith(A)){const t=c[n++],i=s.getAttribute(e).split(C),a=/([.?@])?(.*)/.exec(t);o.push({type:1,index:r,name:a[2],strings:i,ctor:"."===a[1]?ee:"?"===a[1]?te:"@"===a[1]?ie:Q}),s.removeAttribute(e)}else e.startsWith(C)&&(o.push({type:6,index:r}),s.removeAttribute(e));if(F.test(s.tagName)){const e=s.textContent.split(C),t=e.length-1;if(t>0){s.textContent=x?x.emptyScript:"";for(let i=0;i<t;i++)s.append(e[i],M()),q.nextNode(),o.push({type:2,index:++r});s.append(e[t],M())}}}else if(8===s.nodeType)if(s.data===D)o.push({type:2,index:r});else{let e=-1;for(;-1!==(e=s.data.indexOf(C,e+1));)o.push({type:7,index:r}),e+=C.length-1}r++}}static createElement(e,t){const i=E.createElement("template");return i.innerHTML=e,i}}function Y(e,t,i=e,s){if(t===W)return t;let r=void 0!==s?i._$Co?.[s]:i._$Cl;const n=N(t)?void 0:t._$litDirective$;return r?.constructor!==n&&(r?._$AO?.(!1),void 0===n?r=void 0:(r=new n(e),r._$AT(e,i,s)),void 0!==s?(i._$Co??=[])[s]=r:i._$Cl=r),void 0!==r&&(t=Y(e,r._$AS(e,t.values),r,s)),t}class Z{constructor(e,t){this._$AV=[],this._$AN=void 0,this._$AD=e,this._$AM=t}get parentNode(){return this._$AM.parentNode}get _$AU(){return this._$AM._$AU}u(e){const{el:{content:t},parts:i}=this._$AD,s=(e?.creationScope??E).importNode(t,!0);q.currentNode=s;let r=q.nextNode(),n=0,a=0,o=i[0];for(;void 0!==o;){if(n===o.index){let t;2===o.type?t=new X(r,r.nextSibling,this,e):1===o.type?t=new o.ctor(r,o.name,o.strings,this,e):6===o.type&&(t=new se(r,this,e)),this._$AV.push(t),o=i[++a]}n!==o?.index&&(r=q.nextNode(),n++)}return q.currentNode=E,s}p(e){let t=0;for(const i of this._$AV)void 0!==i&&(void 0!==i.strings?(i._$AI(e,i,t),t+=i.strings.length-2):i._$AI(e[t])),t++}}class X{get _$AU(){return this._$AM?._$AU??this._$Cv}constructor(e,t,i,s){this.type=2,this._$AH=j,this._$AN=void 0,this._$AA=e,this._$AB=t,this._$AM=i,this.options=s,this._$Cv=s?.isConnected??!0}get parentNode(){let e=this._$AA.parentNode;const t=this._$AM;return void 0!==t&&11===e?.nodeType&&(e=t.parentNode),e}get startNode(){return this._$AA}get endNode(){return this._$AB}_$AI(e,t=this){e=Y(this,e,t),N(e)?e===j||null==e||""===e?(this._$AH!==j&&this._$AR(),this._$AH=j):e!==this._$AH&&e!==W&&this._(e):void 0!==e._$litType$?this.$(e):void 0!==e.nodeType?this.T(e):(e=>k(e)||"function"==typeof e?.[Symbol.iterator])(e)?this.k(e):this._(e)}O(e){return this._$AA.parentNode.insertBefore(e,this._$AB)}T(e){this._$AH!==e&&(this._$AR(),this._$AH=this.O(e))}_(e){this._$AH!==j&&N(this._$AH)?this._$AA.nextSibling.data=e:this.T(E.createTextNode(e)),this._$AH=e}$(e){const{values:t,_$litType$:i}=e,s="number"==typeof i?this._$AC(e):(void 0===i.el&&(i.el=K.createElement(B(i.h,i.h[0]),this.options)),i);if(this._$AH?._$AD===s)this._$AH.p(t);else{const e=new Z(s,this),i=e.u(this.options);e.p(t),this.T(i),this._$AH=e}}_$AC(e){let t=G.get(e.strings);return void 0===t&&G.set(e.strings,t=new K(e)),t}k(e){k(this._$AH)||(this._$AH=[],this._$AR());const t=this._$AH;let i,s=0;for(const r of e)s===t.length?t.push(i=new X(this.O(M()),this.O(M()),this,this.options)):i=t[s],i._$AI(r),s++;s<t.length&&(this._$AR(i&&i._$AB.nextSibling,s),t.length=s)}_$AR(e=this._$AA.nextSibling,t){for(this._$AP?.(!1,!0,t);e!==this._$AB;){const t=e.nextSibling;e.remove(),e=t}}setConnected(e){void 0===this._$AM&&(this._$Cv=e,this._$AP?.(e))}}class Q{get tagName(){return this.element.tagName}get _$AU(){return this._$AM._$AU}constructor(e,t,i,s,r){this.type=1,this._$AH=j,this._$AN=void 0,this.element=e,this.name=t,this._$AM=s,this.options=r,i.length>2||""!==i[0]||""!==i[1]?(this._$AH=Array(i.length-1).fill(new String),this.strings=i):this._$AH=j}_$AI(e,t=this,i,s){const r=this.strings;let n=!1;if(void 0===r)e=Y(this,e,t,0),n=!N(e)||e!==this._$AH&&e!==W,n&&(this._$AH=e);else{const s=e;let a,o;for(e=r[0],a=0;a<r.length-1;a++)o=Y(this,s[i+a],t,a),o===W&&(o=this._$AH[a]),n||=!N(o)||o!==this._$AH[a],o===j?e=j:e!==j&&(e+=(o??"")+r[a+1]),this._$AH[a]=o}n&&!s&&this.j(e)}j(e){e===j?this.element.removeAttribute(this.name):this.element.setAttribute(this.name,e??"")}}class ee extends Q{constructor(){super(...arguments),this.type=3}j(e){this.element[this.name]=e===j?void 0:e}}class te extends Q{constructor(){super(...arguments),this.type=4}j(e){this.element.toggleAttribute(this.name,!!e&&e!==j)}}class ie extends Q{constructor(e,t,i,s,r){super(e,t,i,s,r),this.type=5}_$AI(e,t=this){if((e=Y(this,e,t,0)??j)===W)return;const i=this._$AH,s=e===j&&i!==j||e.capture!==i.capture||e.once!==i.once||e.passive!==i.passive,r=e!==j&&(i===j||s);s&&this.element.removeEventListener(this.name,this,i),r&&this.element.addEventListener(this.name,this,e),this._$AH=e}handleEvent(e){"function"==typeof this._$AH?this._$AH.call(this.options?.host??this.element,e):this._$AH.handleEvent(e)}}class se{constructor(e,t,i){this.element=e,this.type=6,this._$AN=void 0,this._$AM=t,this.options=i}get _$AU(){return this._$AM._$AU}_$AI(e){Y(this,e)}}const re=w.litHtmlPolyfillSupport;re?.(K,X),(w.litHtmlVersions??=[]).push("3.3.1");const ne=globalThis;let ae=class extends T{constructor(){super(...arguments),this.renderOptions={host:this},this._$Do=void 0}createRenderRoot(){const e=super.createRenderRoot();return this.renderOptions.renderBefore??=e.firstChild,e}update(e){const t=this.render();this.hasUpdated||(this.renderOptions.isConnected=this.isConnected),super.update(e),this._$Do=((e,t,i)=>{const s=i?.renderBefore??t;let r=s._$litPart$;if(void 0===r){const e=i?.renderBefore??null;s._$litPart$=r=new X(t.insertBefore(M(),e),e,void 0,i??{})}return r._$AI(e),r})(t,this.renderRoot,this.renderOptions)}connectedCallback(){super.connectedCallback(),this._$Do?.setConnected(!0)}disconnectedCallback(){super.disconnectedCallback(),this._$Do?.setConnected(!1)}render(){return W}};ae._$litElement$=!0,ae.finalized=!0,ne.litElementHydrateSupport?.({LitElement:ae});const oe=ne.litElementPolyfillSupport;oe?.({LitElement:ae}),(ne.litElementVersions??=[]).push("4.2.1");const le={attribute:!0,type:String,converter:y,reflect:!1,hasChanged:$},ce=(e=le,t,i)=>{const{kind:s,metadata:r}=i;let n=globalThis.litPropertyMetadata.get(r);if(void 0===n&&globalThis.litPropertyMetadata.set(r,n=new Map),"setter"===s&&((e=Object.create(e)).wrapped=!0),n.set(i.name,e),"accessor"===s){const{name:s}=i;return{set(i){const r=t.get.call(this);t.set.call(this,i),this.requestUpdate(s,r,e)},init(t){return void 0!==t&&this.C(s,void 0,e,t),t}}}if("setter"===s){const{name:s}=i;return function(i){const r=this[s];t.call(this,i),this.requestUpdate(s,r,e)}}throw Error("Unsupported decorator location: "+s)};function de(e){return(t,i)=>"object"==typeof i?ce(e,t,i):((e,t,i)=>{const s=t.hasOwnProperty(i);return t.constructor.createProperty(i,e),s?Object.getOwnPropertyDescriptor(t,i):void 0})(e,t,i)}function he(e){return de({...e,state:!0,attribute:!1})}class ue{static getStandardTimerData(e,t,i){const s=t.state,r=t.attributes,n="active"===s,a="paused"===s,o="idle"===s;let l=0;r.duration&&(l=i(r.duration));let c=0,d=null;(n||a)&&(r.finishes_at?(d=new Date(r.finishes_at),isNaN(d.getTime())||(c=Math.max(0,Math.floor((d.getTime()-Date.now())/1e3)))):r.remaining&&(c=i(r.remaining)));let h=0;if(l>0)if(o)h=0;else{const e=l-c;h=Math.min(100,Math.max(0,e/l*100))}return{isActive:n,isPaused:a,duration:l,remaining:c,finishesAt:d,progress:h,isAlexaTimer:!1}}}class me{static getAlexaTimerData(e,t,i,s,r){var n,a,o,l,c,d,h,u,m,p,g,f,_,v;const{state:y,attributes:$}=t,b=null!==(n=this.parseJson($.sorted_active))&&void 0!==n?n:[],T=null!==(a=this.parseJson($.sorted_all))&&void 0!==a?a:[],w=null!==(l=null!==(o=$.total_active)&&void 0!==o?o:b.length)&&void 0!==l?l:0,x=null!==(d=null!==(c=$.total_all)&&void 0!==c?c:T.length)&&void 0!==d?d:0,S=new Map;for(const H of b)Array.isArray(H)&&H.length>=2&&H[0]&&H[1]&&S.set(String(H[0]),H[1]);const A=new Map;for(const H of T)Array.isArray(H)&&H.length>=2&&H[0]&&H[1]&&A.set(String(H[0]),H[1]);const C=Date.now();let D=this.alexaIdCache.get(e);D||(D={},this.alexaIdCache.set(e,D));const I=[];for(const[H,F]of S.entries()){const e="number"==typeof(null==F?void 0:F.triggerTime)?F.triggerTime:0;e&&e<=C&&I.push({id:H,trig:e})}I.length>0?(I.sort((e,t)=>e.trig-t.trig),D.finishedWhileActiveId=I[0].id):D.finishedWhileActiveId&&!S.has(D.finishedWhileActiveId)&&delete D.finishedWhileActiveId;let E,M=!1,N=!1,k=!1,R=null;if(w>0&&b.length>0)if(D.finishedWhileActiveId&&S.has(D.finishedWhileActiveId))E=D.finishedWhileActiveId,R=null!==(h=S.get(E))&&void 0!==h?h:null,M=!!R,k=!0;else{if(1===b.length)E=String(null===(u=b[0])||void 0===u?void 0:u[0]),R=null!==(p=null===(m=b[0])||void 0===m?void 0:m[1])&&void 0!==p?p:null;else{let e,t=null,i=Number.POSITIVE_INFINITY;for(const s of b){const r=String(null==s?void 0:s[0]),n=null==s?void 0:s[1];n&&"number"==typeof n.remainingTime&&n.remainingTime<i&&(i=n.remainingTime,t=n,e=r)}E=e,R=t}M=!!R,M&&R&&"number"==typeof R.triggerTime&&R.triggerTime<=C&&(k=!0,D.finishedWhileActiveId=E)}else if(x>0&&T.length>0){let e=null,t=-1/0;for(const[i,s]of A.entries())if("PAUSED"===(null==s?void 0:s.status)){const r="number"==typeof s.lastUpdatedDate?s.lastUpdatedDate:-1/0;r>t&&(t=r,e=s,E=i)}e&&(R=e,N=!0)}let P=0,O=0,U=null,L=0;if(R){const e=Date.now(),t="number"==typeof R.remainingTime?R.remainingTime:0,i="number"==typeof R.originalDurationInMillis?R.originalDurationInMillis:0,s="number"==typeof R.triggerTime?R.triggerTime:0;if(O=Math.max(0,Math.floor(i/1e3)),M?(s&&s>e?(P=Math.max(0,Math.floor((s-e)/1e3)),U=new Date(s)):(P=Math.max(0,Math.floor(t/1e3)),P>0&&(U=new Date(e+1e3*P))),(s&&s<=e||P<=0||"OFF"===R.status&&0===t)&&(P=0,U=null,k=!0)):(P=Math.max(0,Math.floor(t/1e3)),U=null),O>0){const e=Math.max(0,O-P);L=Math.min(100,Math.max(0,e/O*100)),M&&L>=100&&(P=0,k=!0)}}else{if(y&&"unavailable"!==y&&"unknown"!==y&&(s(y)?(U=new Date(y),isNaN(U.getTime())||(P=Math.max(0,Math.floor((U.getTime()-Date.now())/1e3)))):isNaN(parseFloat(y))?"string"==typeof y&&y.includes(":")&&(P=r(y)):P=Math.max(0,parseFloat(y))),$.original_duration)O=r($.original_duration);else if($.duration)O=r($.duration);else if(U&&t.last_changed){const e=new Date(t.last_changed).getTime(),i=U.getTime();!isNaN(e)&&i>e&&(O=Math.floor((i-e)/1e3))}if(O>0){const e=O-P;L=Math.min(100,Math.max(0,e/O*100))}}let z=null==R?void 0:R.timerLabel;return!z&&b.length>0&&(z=null===(f=null===(g=b[0])||void 0===g?void 0:g[1])||void 0===f?void 0:f.timerLabel),!z&&T.length>0&&(z=null===(v=null===(_=T[0])||void 0===_?void 0:_[1])||void 0===v?void 0:v.timerLabel),{isActive:M,isPaused:N,duration:O,remaining:P,finishesAt:U,progress:L,finished:k,isAlexaTimer:!0,alexaDevice:this.extractAlexaDevice(e,$),timerLabel:null!=z?z:this.extractAlexaDevice(e,$),timerStatus:N?"PAUSED":M?"ON":"OFF",userDefinedLabel:z}}static parseLegacyAlexaTimer(e,t,i,s,r,n){let a=0,o=0,l=null,c=!1;if(i&&"unavailable"!==i&&"unknown"!==i)if(r(i)){if(l=new Date(i),!isNaN(l.getTime())){const e=Date.now();a=Math.max(0,Math.floor((l.getTime()-e)/1e3)),c=a>0}}else isNaN(parseFloat(i))?"string"==typeof i&&i.includes(":")&&(a=n(i),c=a>0):(a=Math.max(0,parseFloat(i)),c=a>0);let d=!1;if(s.original_duration)o=n(s.original_duration),d=!0;else if(s.duration)o=n(s.duration),d=!0;else if(l&&t.last_changed){const e=new Date(t.last_changed).getTime(),i=l.getTime();!isNaN(e)&&i>e&&(o=Math.floor((i-e)/1e3),d=!0)}d||(o=a>0?a:0,d=!1);let h=0;if(d&&o>0)if(c&&a>=0){const e=o-a;h=Math.min(100,Math.max(0,e/o*100))}else 0===a&&o>0&&(h=100);else if(c&&a>0){const e=t.last_changed?new Date(t.last_changed).getTime():Date.now(),i=(Date.now()-e)/1e3;if(i<a){const e=a+i,t=i;h=Math.min(100,Math.max(0,t/e*100))}else h=0}else h=0;return{isActive:c,isPaused:!1,duration:o,remaining:a,finishesAt:l,progress:h,isAlexaTimer:!0,alexaDevice:this.extractAlexaDevice(e,s),timerLabel:s.friendly_name||s.timer_label||this.formatAlexaTimerName(e),timerStatus:c?"ON":"OFF",userDefinedLabel:void 0}}static discoverAlexaTimers(e,t,i){var s,r;if(!e||!e.states)return[];const n=[];for(const a in e.states)if(t(a)){const t=e.states[a].attributes||{},o=null!==(s=this.parseJson(t.sorted_active))&&void 0!==s?s:[],l=null!==(r=this.parseJson(t.sorted_all))&&void 0!==r?r:[],c=Array.isArray(o)&&o.length>0;let d=!1;if(!c&&Array.isArray(l)&&l.length>0)for(const e of l){const t=null==e?void 0:e[1];if(t&&"PAUSED"===t.status&&"number"==typeof t.remainingTime&&t.remainingTime>0){d=!0;break}}if(c||d){n.push(a);continue}const h=i(a,e);h&&(h.isActive||h.isPaused)&&n.push(a)}return n}static parseJson(e){if(Array.isArray(e))return e;if("string"==typeof e)try{return JSON.parse(e)}catch{}return null}static extractAlexaDevice(e,t){if(t.friendly_name){let e=t.friendly_name;if(e=e.replace(/\s*next\s*timer$/i,"").replace(/\s*timer$/i,"").replace(/\s*echo\s*timer$/i,"").replace(/\s*alexa\s*timer$/i,"").trim(),e)return e}if(e.includes("_next_timer")){const t=e.replace(/^sensor\./,"").replace(/_next_timer$/,"").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());if(t)return t}return t.device_name?t.device_name:t.device?t.device:"Alexa Device"}static formatAlexaTimerName(e){return e.replace(/^sensor\./,"").replace(/_next_timer$/,"").replace(/_timer$/,"").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}}me.alexaIdCache=new Map;class pe{static getGoogleTimerData(e,t,i,s){const{state:r,attributes:n}=t,a=n.timers||[];if(!Array.isArray(a)||0===a.length){const t=this.googleIdCache.get(e);return(null==t?void 0:t.finishedTimerId)?{isActive:!1,isPaused:!1,duration:t.lastDuration||0,remaining:0,finishesAt:null,progress:100,finished:!0,isGoogleTimer:!0,userDefinedLabel:t.lastLabel||void 0,googleTimerId:t.finishedTimerId,googleTimerStatus:"ringing"}:{isActive:!1,isPaused:!1,duration:0,remaining:0,finishesAt:null,progress:0,finished:!1,isGoogleTimer:!0,userDefinedLabel:void 0,googleTimerId:void 0,googleTimerStatus:"none"}}const o=new Map,l=new Map;for(const S of a)S.timer_id&&(l.set(String(S.timer_id),S),"set"!==S.status&&"ringing"!==S.status||o.set(String(S.timer_id),S));const c=Date.now()/1e3;let d=this.googleIdCache.get(e);d||(d={},this.googleIdCache.set(e,d));const h=[];for(const[S,A]of o.entries())A.fire_time&&A.fire_time<=c&&"ringing"!==A.status&&h.push({id:S,fireTime:A.fire_time,timer:A});for(const S of a)if(S.timer_id&&"ringing"===S.status){const e=String(S.timer_id),t=S.fire_time||c-1;h.push({id:e,fireTime:t,timer:S})}if(h.length>0){h.sort((e,t)=>t.fireTime-e.fireTime),d.finishedTimerId=h[0].id;const e=h[0].timer;e&&(d.lastDuration=e.duration||0,d.lastLabel=e.label||"Timer")}d.finishedTimerId&&!o.has(d.finishedTimerId)&&setTimeout(()=>{const t=this.googleIdCache.get(e);if(t&&t.finishedTimerId===d.finishedTimerId){let s=!1;const r=i.states[e];if(r&&r.attributes&&r.attributes.timers){s=(r.attributes.timers||[]).some(e=>"set"===e.status||"ringing"===e.status)}s&&(delete t.finishedTimerId,delete t.lastDuration,delete t.lastLabel)}},3e4);let u=null,m=null;for(const S of a)if(S.timer_id&&"ringing"===S.status)return{isActive:!1,isPaused:!1,duration:S.duration||0,remaining:0,finishesAt:null,progress:100,finished:!0,isGoogleTimer:!0,userDefinedLabel:S.label||void 0,googleTimerId:String(S.timer_id),googleTimerStatus:"ringing"};if(d.finishedTimerId&&l.has(d.finishedTimerId)){const e=l.get(d.finishedTimerId);if(e&&e.fire_time<=c)return{isActive:!1,isPaused:!1,duration:e.duration||0,remaining:0,finishesAt:null,progress:100,finished:!0,isGoogleTimer:!0,userDefinedLabel:e.label||void 0,googleTimerId:String(e.timer_id),googleTimerStatus:e.status||"ringing"}}let p=Number.POSITIVE_INFINITY;for(const[S,A]of o.entries())A.fire_time&&A.fire_time<p&&(p=A.fire_time,u=A,m=S);if(!u){for(const e of a)if(e.timer_id){const t=String(e.status||"").toLowerCase().trim();if(console.log(`🔍 GoogleTimer: Checking timer ${e.timer_id} with status "${e.status}" (normalized: "${t}")`),"paused"===t){console.log(`✅ GoogleTimer: Found paused timer ${e.timer_id}`),u=e,m=String(e.timer_id);break}}u||console.log(`❌ GoogleTimer: No paused timers found among ${a.length} timers`)}if(!u){if(!(a.length>0))return null;u=a[0],m=String(a[0].timer_id||"unknown")}const g=String(u.status||"").toLowerCase().trim(),f="set"===g||"ringing"===g,_="paused"===g,v="ringing"===g,y="number"==typeof u.duration?u.duration:s(u.duration||"0");let $=0,b=null,T=!1;d.pausedSnapshots||(d.pausedSnapshots=new Map);const w=d.pausedSnapshots.get(m);if(f){const e=u.fire_time?1e3*u.fire_time:0;e&&e>Date.now()?($=Math.max(0,Math.floor((e-Date.now())/1e3)),b=new Date(e),d.pausedSnapshots.set(m,{remaining:$,pausedAt:c,wasActive:!0})):($=0,b=null,T=!0)}else _?($=w?w.remaining:y,d.pausedSnapshots.set(m,{remaining:$,pausedAt:c,wasActive:!1}),b=null):($=0,b=null,T=!0);let x=0;if(y>0)if(v||T||0===$&&!_)x=100,console.log(`🔔 GoogleTimer: Setting progress to 100 for timer ${m} - isRinging: ${v}, isFinished: ${T}, remaining: ${$}, isPaused: ${_}`);else{const e=Math.max(0,y-$);x=Math.min(100,Math.max(0,e/y*100)),console.log(`⏱️ GoogleTimer: Calculated progress ${x}% for timer ${m} - elapsed: ${e}, duration: ${y}, remaining: ${$}`)}else console.log(`⚠️ GoogleTimer: Duration is 0 for timer ${m}, progress stays 0`);return T||(T=v||0===$&&!_),d.pausedSnapshots&&m&&(T||f)&&(f&&!1===(null==w?void 0:w.wasActive)||T)&&d.pausedSnapshots.delete(m),{isActive:f&&!v,isPaused:_,duration:y,remaining:$,finishesAt:b,progress:x,finished:T,isGoogleTimer:!0,userDefinedLabel:u.label||void 0,googleTimerId:m||void 0,googleTimerStatus:u.status}}static discoverGoogleTimers(e,t,i){if(!e||!e.states)return[];const s=[];for(const r in e.states)if(t(r)){const t=e.states[r];console.log(`🔍 Discovery: Checking entity ${r} with state "${t.state}"`);const i=(t.attributes||{}).timers||[];if(console.log(`🔍 Discovery: Entity ${r} has ${i.length} timers`),Array.isArray(i)&&i.length>0){const e=i.some(e=>{const t=String(e.status||"").toLowerCase().trim();return console.log(`🔍 Discovery: Timer ${e.timer_id} status: "${e.status}" (normalized: "${t}")`),"set"===t||"ringing"===t||"paused"===t});console.log(`🔍 Discovery: Entity ${r} hasDisplayableTimer: ${e}`),e?(s.push(r),console.log(`✅ Discovery: Added ${r} to results`)):console.log(`❌ Discovery: Skipped ${r} - no displayable timers`)}else console.log(`❌ Discovery: Skipped ${r} - no timers array`)}return s}static clearFinishedTimer(e){const t=this.googleIdCache.get(e);t&&t.finishedTimerId&&(delete t.finishedTimerId,delete t.lastDuration,delete t.lastLabel)}}pe.googleIdCache=new Map;class ge{static isTimerEntity(e){return!!e&&(!!e.startsWith("timer.")||(!!(e.includes("_next_timer")||e.includes("alexa_timer")||e.startsWith("sensor.")&&e.includes("timer"))||(!(!e.startsWith("sensor.")||!e.endsWith("_timers"))||!(!e.includes("google_home")||!e.includes("timer")))))}static isAlexaTimer(e){return e.includes("_next_timer")||e.includes("alexa_timer")||e.startsWith("sensor.")&&e.includes("alexa")&&e.includes("timer")}static isGoogleTimer(e){return!(!e.startsWith("sensor.")||!e.endsWith("_timers"))||e.includes("google_home")&&e.includes("timer")}static getTimerData(e,t){if(!t||!e||!this.isTimerEntity(e))return null;const i=t.states[e];return i?this.isAlexaTimer(e)?me.getAlexaTimerData(e,i,t,this.isISOTimestamp,this.parseDuration):this.isGoogleTimer(e)?pe.getGoogleTimerData(e,i,t,this.parseDuration):ue.getStandardTimerData(e,i,this.parseDuration):null}static discoverAlexaTimers(e){return me.discoverAlexaTimers(e,e=>this.isAlexaTimer(e),(e,t)=>this.getTimerData(e,t))}static discoverGoogleTimers(e){return pe.discoverGoogleTimers(e,e=>this.isGoogleTimer(e),(e,t)=>this.getTimerData(e,t))}static isISOTimestamp(e){return/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?([+-]\d{2}:\d{2}|Z)?$/.test(e)}static parseDuration(e){if("number"==typeof e)return e;if("string"!=typeof e)return 0;if(e.includes(":")){const t=e.split(":").map(Number);if(3===t.length)return 3600*t[0]+60*t[1]+t[2];if(2===t.length)return 60*t[0]+t[1]}const t=parseFloat(e);return isNaN(t)?0:t}static formatRemainingTime(e,t=!0){if(e<=0)return"0:00";const i=Math.floor(e/3600),s=Math.floor(e%3600/60),r=Math.floor(e%60);return i>0?t?`${i}:${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`:`${i}:${s.toString().padStart(2,"0")}`:t?`${s}:${r.toString().padStart(2,"0")}`:`${s}m`}static getTimerTitle(e,t,i){if(i)return i;if(!t||!e)return"Timer";const s=t.states[e];if(!s)return"Timer";if(this.isAlexaTimer(e)){const i=me.getAlexaTimerData(e,s,t,this.isISOTimestamp,this.parseDuration);return(null==i?void 0:i.timerLabel)?i.timerLabel:this.formatAlexaTimerName(e)}if(this.isGoogleTimer(e)){const i=pe.getGoogleTimerData(e,s,t,this.parseDuration);return(null==i?void 0:i.userDefinedLabel)?i.userDefinedLabel:this.formatGoogleTimerName(e)}return s.attributes.friendly_name||e.replace("timer.","").replace(/_/g," ")}static formatAlexaTimerName(e){return e.replace(/^sensor\./,"").replace(/_next_timer$/,"").replace(/_timer$/,"").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}static formatGoogleTimerName(e){return e.replace(/^sensor\./,"").replace(/_timers$/,"").replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())+" Timers"}static isTimerExpired(e){return!!e&&(e.isAlexaTimer||e.isGoogleTimer?!!e.finished||0===e.remaining&&e.progress>=100:!e.isActive&&!e.isPaused&&e.progress>=100)}static getTimerSubtitle(e,t=!0){if(!e)return"Timer not found";if(e.isAlexaTimer){if(e.finished)return e.userDefinedLabel?`${e.userDefinedLabel} timer complete`:"Timer complete";if(e.isActive&&e.remaining>0){const i=this.formatRemainingTime(e.remaining,t);return e.userDefinedLabel?`${i} remaining on ${e.userDefinedLabel} timer`:e.alexaDevice?`${i} remaining on ${e.alexaDevice}`:`${i} remaining`}if(e.isPaused&&e.remaining>0){const i=this.formatRemainingTime(e.remaining,t);return e.userDefinedLabel?`${e.userDefinedLabel} timer paused - ${i} left`:e.alexaDevice?`Timer paused on ${e.alexaDevice} - ${i} left`:`Timer paused - ${i} left`}return e.finished||0===e.remaining&&e.progress>=100?e.userDefinedLabel?`${e.userDefinedLabel} timer complete`:"Timer complete":e.alexaDevice?`No timers on ${e.alexaDevice}`:"No timers"}if(e.isGoogleTimer){const i="ringing"===e.googleTimerStatus;if(e.finished||i)return e.userDefinedLabel?`${e.userDefinedLabel} timer complete`:"Timer complete";if(e.isActive&&e.remaining>0){const i=this.formatRemainingTime(e.remaining,t);return e.userDefinedLabel?`${i} remaining on ${e.userDefinedLabel} timer`:`${i} remaining on Google Home`}if(e.isPaused&&e.remaining>0){const i=this.formatRemainingTime(e.remaining,t);return e.userDefinedLabel?`${e.userDefinedLabel} timer paused - ${i} left`:`Google Home timer paused - ${i} left`}return e.finished||i||0===e.remaining&&e.progress>=100?e.userDefinedLabel?`${e.userDefinedLabel} timer complete`:"Timer complete":"No Google Home timers"}return e.isActive?`${this.formatRemainingTime(e.remaining,t)} remaining`:e.isPaused?`Paused - ${this.formatRemainingTime(e.remaining,t)} left`:e.duration>0?`Ready - ${this.formatRemainingTime(e.duration,t)}`:"Timer ready"}static getTimerStateColor(e,t="#4caf50"){return e?e.isAlexaTimer?e.isActive&&e.remaining>0?"#00d4ff":this.isTimerExpired(e)?"#ff4444":"#888888":e.isGoogleTimer?e.isActive&&e.remaining>0?"#34a853":this.isTimerExpired(e)?"#ff4444":"#888888":e.isActive?"#4caf50":e.isPaused?"#ff9800":this.isTimerExpired(e)?"#f44336":"#9e9e9e":t}}class fe{static parseISODate(e){try{const t=this.parseISODateManual(e);if(!isNaN(t))return t}catch(i){}const t=new Date(e);return!isNaN(t.getTime())&&this.isValidDateResult(t,e)?t.getTime():this.parseISODateFallback(e)}static isValidDateResult(e,t){const i=e.getTime(),s=new Date("1970-01-01").getTime(),r=new Date("2100-12-31").getTime();if(i<s||i>r)return!1;if("string"==typeof t&&t.includes("02-29")){const t=e.getFullYear();if(!this.isLeapYear(t))return!1}return!0}static isLeapYear(e){return e%4==0&&e%100!=0||e%400==0}static parseISODateManual(e){if("string"==typeof e&&e.includes("T")){if(/[+-]\d{2}:\d{2}$|Z$/.test(e))return new Date(e).getTime();{const[t,i]=e.split("T"),[s,r,n]=t.split("-").map(Number);if(!this.isValidDateComponents(s,r,n))throw new Error("Invalid date components");if(i&&i.includes(":")){const[e,t,a]=i.split(":").map(parseFloat);if(!this.isValidTimeComponents(e,t,a))throw new Error("Invalid time components");return new Date(s,r-1,n,e,t,a||0).getTime()}return new Date(s,r-1,n).getTime()}}return new Date(e).getTime()}static isValidDateComponents(e,t,i){if(isNaN(e)||isNaN(t)||isNaN(i))return!1;if(e<1970||e>2100)return!1;if(t<1||t>12)return!1;if(i<1||i>31)return!1;return!(i>[31,this.isLeapYear(e)?29:28,31,30,31,30,31,31,30,31,30,31][t-1])}static isValidTimeComponents(e,t,i){const s=parseInt(e),r=parseInt(t),n=parseInt(i);return!(isNaN(s)||isNaN(r)||isNaN(n))&&(!(s<0||s>23)&&(!(r<0||r>59)&&!(n<0||n>59)))}static parseISODateFallback(e){try{const t=Date.parse(e);return isNaN(t)?Date.now():t}catch(t){return Date.now()}}}class _e{static validateConfig(e){const t=[];if(!e)return t.push({field:"config",message:"Configuration object is missing or empty",severity:"critical",suggestion:"Provide a valid configuration object with at least a target_date field.",value:e}),{isValid:!1,errors:t,hasCriticalErrors:!0,hasWarnings:!1};e.target_date?this.isValidDateInput(e.target_date)||t.push({field:"target_date",message:"Invalid target_date format",severity:"critical",suggestion:'Use ISO date string (2025-12-31T23:59:59), entity ID (sensor.my_date), or template ({{ states("sensor.date") }}).',value:e.target_date}):e.timer_entity||e.auto_discover_alexa||e.auto_discover_google||t.push({field:"target_date",message:'Either "target_date", "timer_entity", "auto_discover_alexa", or "auto_discover_google" must be provided',severity:"critical",suggestion:'Add target_date field with a valid date value like "2025-12-31T23:59:59" OR specify a timer_entity like "timer.my_timer" OR enable auto_discover_alexa OR enable auto_discover_google.',value:void 0}),e.timer_entity&&!this.isValidEntityId(e.timer_entity)&&t.push({field:"timer_entity",message:"Invalid timer_entity format",severity:"warning",suggestion:'Use a valid entity ID like "timer.my_timer", "sensor.alexa_timer", or "sensor.kitchen_display_timers" (Google Home).',value:e.timer_entity}),e.creation_date&&!this.isValidDateInput(e.creation_date)&&t.push({field:"creation_date",message:"Invalid creation_date format",severity:"warning",suggestion:"Use ISO date string, entity ID, or template. This field is optional.",value:e.creation_date});["color","background_color","progress_color"].forEach(i=>{e[i]&&!this.isValidColorInput(e[i])&&t.push({field:i,message:`Invalid ${i} format`,severity:"warning",suggestion:"Use hex (#ff0000), rgb/rgba, hsl/hsla, CSS color name, entity ID, or template.",value:e[i]})});["width","height","icon_size"].forEach(i=>{e[i]&&!this.isValidDimensionInput(e[i])&&t.push({field:i,message:`Invalid ${i} format`,severity:"warning",suggestion:"Use pixel values (100px), percentages (50%), or CSS units (2rem).",value:e[i]})}),e.aspect_ratio&&!this.isValidAspectRatioInput(e.aspect_ratio)&&t.push({field:"aspect_ratio",message:"Invalid aspect_ratio format",severity:"warning",suggestion:'Use format like "16/9", "4/3", or "1/1".',value:e.aspect_ratio}),void 0===e.stroke_width||this.isValidNumberInput(e.stroke_width,1,50)||t.push({field:"stroke_width",message:"Invalid stroke_width value",severity:"warning",suggestion:"Must be a number between 1 and 50.",value:e.stroke_width});["show_months","show_days","show_hours","show_minutes","show_seconds","expired_animation","show_progress_text"].forEach(i=>{void 0===e[i]||this.isValidBooleanInput(e[i])||t.push({field:i,message:`Invalid ${i} value`,severity:"warning",suggestion:"Must be true or false (boolean value).",value:e[i]})});["title","subtitle","expired_text"].forEach(i=>{e[i]&&!this.isValidTextInput(e[i])&&t.push({field:i,message:`Invalid ${i} - contains potentially unsafe content`,severity:"critical",suggestion:"Remove script tags, javascript: URLs, and event handlers for security.",value:e[i]})}),e.styles&&!this.isValidStylesInput(e.styles)&&t.push({field:"styles",message:"Invalid styles object structure",severity:"warning",suggestion:"Must contain valid style arrays for card, title, subtitle, or progress_circle.",value:e.styles}),this._addHelpfulValidations(e,t);const i=this._generateSafeConfig(e,t),s=t.filter(e=>"critical"===e.severity),r=t.filter(e=>"warning"===e.severity);return{isValid:0===s.length&&0===r.length,errors:t,hasCriticalErrors:s.length>0,hasWarnings:r.length>0,safeConfig:i}}static _addHelpfulValidations(e,t){}static _generateSafeConfig(e,t){const i={...e};return t.forEach(e=>{if("critical"===e.severity||"warning"===e.severity)switch(e.field){case"target_date":if(!(i.target_date||i.timer_entity||i.auto_discover_alexa||i.auto_discover_google)){const e=new Date;e.setDate(e.getDate()+1),i.target_date=e.toISOString()}break;case"background_color":this.isValidColorInput(i.background_color)||(i.background_color="#1a1a1a");break;case"progress_color":this.isValidColorInput(i.progress_color)||(i.progress_color="#4caf50");break;case"stroke_width":this.isValidNumberInput(i.stroke_width,1,50)||(i.stroke_width=15);break;case"icon_size":this.isValidDimensionInput(i.icon_size)||(i.icon_size=100)}}),i}static validateConfigLegacy(e){const t=this.validateConfig(e);if(t.hasCriticalErrors){const e=t.errors.filter(e=>"critical"===e.severity);throw new Error(`Configuration validation failed:\n• ${e.map(e=>e.message).join("\n• ")}`)}}static isValidDateInput(e){if(!e)return!1;if(this.isTemplate(e))return!0;if("string"==typeof e&&e.includes("."))return!0;if("string"==typeof e)try{const t=new Date(e);return!isNaN(t.getTime())}catch(t){return!1}return!1}static isValidColorInput(e){if(!e)return!1;if(this.isTemplate(e)||"string"==typeof e&&e.includes("."))return!0;if("string"!=typeof e)return!1;if(/^#([0-9A-F]{3}){1,2}$/i.test(e))return!0;if(/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(,\s*[\d.]+\s*)?\)$/i.test(e))return!0;if(/^hsla?\(\s*\d+\s*,\s*\d+%\s*,\s*\d+%\s*(,\s*[\d.]+\s*)?\)$/i.test(e))return!0;return["red","blue","green","yellow","orange","purple","pink","brown","black","white","gray","grey","cyan","magenta","lime","maroon","navy","olive","teal","silver","gold","indigo","violet","transparent","currentColor","inherit","initial","unset"].includes(e.toLowerCase())}static isValidDimensionInput(e){if(!e)return!1;if(this.isTemplate(e)||"string"==typeof e&&e.includes("."))return!0;if("number"==typeof e)return!0;if("string"!=typeof e)return!1;const t=e.match(/^(\d+(?:\.\d+)?)px$/i);if(t){const e=parseFloat(t[1]);return e>=0&&e<=1e4}const i=e.match(/^(\d+(?:\.\d+)?)%$/i);if(i){const e=parseFloat(i[1]);return e>=0&&e<=1e3}const s=["em","rem","vh","vw","vmin","vmax","ch","ex"];for(const r of s){const t=new RegExp(`^(\\d+(?:\\.\\d+)?)${r}$`,"i"),i=e.match(t);if(i){const e=parseFloat(i[1]);return e>=0&&e<=1e3}}return["auto","fit-content","min-content","max-content"].includes(e.toLowerCase())}static isValidAspectRatioInput(e){if(!e)return!1;if(this.isTemplate(e)||"string"==typeof e&&e.includes("."))return!0;if("string"!=typeof e)return!1;const t=e.match(/^(\d+(?:\.\d+)?)\/(\d+(?:\.\d+)?)$/);if(t){const e=parseFloat(t[1]),i=parseFloat(t[2]);return e>0&&i>0&&e<=20&&i<=20}return!1}static isValidNumberInput(e,t=-1/0,i=1/0){if(null==e)return!1;if("string"==typeof e){if(this.isTemplate(e)||e.includes("."))return!0;const s=parseFloat(e);return!isNaN(s)&&s>=t&&s<=i}return"number"==typeof e&&!isNaN(e)&&e>=t&&e<=i}static isValidBooleanInput(e){return"boolean"==typeof e}static isValidTextInput(e){if(!e)return!0;if(this.isTemplate(e)||"string"==typeof e&&e.includes("."))return!0;if("string"!=typeof e)return!1;return![/<script/i,/javascript:/i,/vbscript:/i,/on\w+\s*=/i,/<iframe/i,/<object/i,/<embed/i,/<form/i].some(t=>t.test(e))}static isValidStylesInput(e){if(!e||"object"!=typeof e)return!1;const t=["card","title","subtitle","progress_circle"],i=Object.keys(e);return!!i.every(e=>t.includes(e))&&i.every(t=>Array.isArray(e[t]))}static isTemplate(e){return"string"==typeof e&&e.includes("{{")&&e.includes("}}")}static isValidEntityId(e){if(!e||"string"!=typeof e)return!1;if(this.isTemplate(e))return!0;return/^[a-z_]+\.[a-z0-9_]+$/.test(e)}}class ve{constructor(){this.templateResults=new Map,this.templateCacheLimit=100}async evaluateTemplate(e,t){if(!t||!e)return e;const i=e;if(this.templateResults.has(i)){const e=this.templateResults.get(i);if(e&&Date.now()-e.timestamp<5e3)return e.result}try{if(!this.isValidTemplate(e))throw new Error("Invalid template format");const s=await t.callApi("POST","template",{template:e});if("unknown"===s||"unavailable"===s||""===s||null===s){const t=this.extractFallbackFromTemplate(e);if(t&&t!==e)return this.templateResults.set(i,{result:t,timestamp:Date.now()}),this.enforceTemplateCacheLimit(),t}return this.templateResults.set(i,{result:s,timestamp:Date.now()}),this.enforceTemplateCacheLimit(),s}catch(s){const t=this.extractFallbackFromTemplate(e);return this.templateResults.set(i,{result:t,timestamp:Date.now()}),this.enforceTemplateCacheLimit(),t}}extractFallbackFromTemplate(e){if(!e||"string"!=typeof e)return e;try{const t=e.replace(/^\{\{\s*/,"").replace(/\s*\}\}$/,"").trim(),i=/^(.+?)\s+or\s+['"`]([^'"`]+)['"`]$/,s=t.match(i);if(s&&s[2])return s[2];const r=/^(.+?)\s+or\s+(.+?)\s+or\s+['"`]([^'"`]+)['"`]$/,n=t.match(r);if(n&&n[3])return n[3];const a=/^['"`]([^'"`]+)['"`]\s+if\s+(.+?)\s+else\s+['"`]([^'"`]+)['"`]$/,o=t.match(a);if(o&&o[3])return o[3];const l=/^(.+?)\s+if\s+(.+?)\s+else\s+['"`]([^'"`]+)['"`]$/,c=t.match(l);return c&&c[3]?c[3]:"Unavailable"}catch(t){return"Template Error"}}isTemplate(e){return"string"==typeof e&&e.includes("{{")&&e.includes("}}")}isValidTemplate(e){if(!e||"string"!=typeof e)return!1;if(!e.includes("{{")||!e.includes("}}"))return!1;if((e.match(/\{\{/g)||[]).length!==(e.match(/\}\}/g)||[]).length)return!1;return!!e.replace(/\{\{\s*/,"").replace(/\s*\}\}/,"").trim()}async resolveValue(e){var t,i;if(!e)return;if(this.isTemplate(e)){const i=(null===(t=this.card)||void 0===t?void 0:t.hass)||null;return await this.evaluateTemplate(e,i)||void 0}const s=null===(i=this.card)||void 0===i?void 0:i.hass;if("string"==typeof e&&e.includes(".")&&s&&s.states[e]){const t=s.states[e];if(!t)return;return t.state}return e}clearTemplateCache(){this.templateResults.clear()}enforceTemplateCacheLimit(){if(this.templateResults.size<=this.templateCacheLimit)return;const e=Array.from(this.templateResults.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp),t=e.length-this.templateCacheLimit;for(let i=0;i<t;i++)this.templateResults.delete(e[i][0])}hasTemplatesInConfig(e){if(!e)return!1;return["target_date","creation_date","title","subtitle","color","background_color","progress_color","primary_color","secondary_color"].some(t=>e[t]&&this.isTemplate(e[t]))}escapeHtml(e){return null==e||void 0===e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}}class ye{constructor(e,t){this.templateService=e,this.dateParser=t,this.timeRemaining={months:0,days:0,hours:0,minutes:0,seconds:0,total:0},this.expired=!1,this.lastAlexaTimerData=null}async updateCountdown(e,t){try{if(e.timer_entity&&t){const i=ge.getTimerData(e.timer_entity,t);if(i)return this.timeRemaining=this._timerDataToCountdownState(i),this.expired=ge.isTimerExpired(i),this.timeRemaining}if(!e.timer_entity&&(e.auto_discover_alexa||e.auto_discover_google)&&t){let i=[];if(e.auto_discover_alexa){const e=ge.discoverAlexaTimers(t);i.push(...e)}if(e.auto_discover_google){const e=ge.discoverGoogleTimers(t);i.push(...e)}if(i.length>0){console.log(`🔍 CountdownService: Found ${i.length} smart timers: ${i}`);let e=i.find(e=>{const i=ge.getTimerData(e,t);return console.log(`🔍 CountdownService: Checking ${e} - isActive: ${null==i?void 0:i.isActive}, isPaused: ${null==i?void 0:i.isPaused}, status: ${(null==i?void 0:i.googleTimerStatus)||(null==i?void 0:i.timerStatus)}`),i&&i.isActive});if(e||(e=i.find(e=>{const i=ge.getTimerData(e,t);return console.log(`🔍 CountdownService: Checking paused ${e} - isActive: ${null==i?void 0:i.isActive}, isPaused: ${null==i?void 0:i.isPaused}, status: ${(null==i?void 0:i.googleTimerStatus)||(null==i?void 0:i.timerStatus)}`),i&&i.isPaused})),console.log(`🔍 CountdownService: Chosen timer: ${e||"none"}`),e){const i=ge.getTimerData(e,t);if(i)return this.lastAlexaTimerData=i,this.timeRemaining=this._timerDataToCountdownState(i),this.expired=ge.isTimerExpired(i),this.timeRemaining}if(this.lastAlexaTimerData&&ge.isTimerExpired(this.lastAlexaTimerData))return this.timeRemaining=this._timerDataToCountdownState(this.lastAlexaTimerData),this.expired=!0,this.timeRemaining}return this.lastAlexaTimerData=null,this.timeRemaining={months:0,days:0,hours:0,minutes:0,seconds:0,total:0},this.expired=!1,this.timeRemaining}if(!e.target_date)return this.timeRemaining;const i=(new Date).getTime(),s=await this.templateService.resolveValue(e.target_date);if(!s)return this.timeRemaining;const r=this.dateParser.parseISODate(s);if(isNaN(r))return this.timeRemaining;const n=r-i;if(n>0){const{show_months:t,show_days:i,show_hours:s,show_minutes:r,show_seconds:a}=e;let o=n,l=0,c=0,d=0,h=0,u=0;if(t&&(l=Math.floor(o/2630016e3),o%=2630016e3),i)c=Math.floor(o/864e5),o%=864e5;else if(t&&!i){const e=Math.floor(o/864e5);l+=Math.floor(e/30.44),o%=864e5}if(s)d=Math.floor(o/36e5),o%=36e5;else if((t||i)&&!s){const e=Math.floor(o/36e5);i?c+=Math.floor(e/24):t&&(l+=Math.floor(e/(24*30.44))),o%=36e5}if(r)h=Math.floor(o/6e4),o%=6e4;else if((t||i||s)&&!r){const e=Math.floor(o/6e4);s?d+=Math.floor(e/60):i?c+=Math.floor(e/1440):t&&(l+=Math.floor(e/43833.6)),o%=6e4}if(a)u=Math.floor(o/1e3);else if((t||i||s||r)&&!a){const e=Math.floor(o/1e3);r?h+=Math.floor(e/60):s?d+=Math.floor(e/3600):i?c+=Math.floor(e/86400):t&&(l+=Math.floor(e/2630016))}this.timeRemaining={months:l,days:c,hours:d,minutes:h,seconds:u,total:n},this.expired=!1}else this.timeRemaining={months:0,days:0,hours:0,minutes:0,seconds:0,total:0},this.expired=!0;return this.timeRemaining}catch(i){return this.timeRemaining}}async calculateProgress(e,t){if(e.timer_entity&&t){const i=ge.getTimerData(e.timer_entity,t);return i?i.progress:0}if(!e.timer_entity&&(e.auto_discover_alexa||e.auto_discover_google)&&t){let i=[];if(e.auto_discover_alexa){const e=ge.discoverAlexaTimers(t);i.push(...e)}if(e.auto_discover_google){const e=ge.discoverGoogleTimers(t);i.push(...e)}if(i.length>0){let e=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isActive});if(e||(e=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isPaused})),e){const i=ge.getTimerData(e,t);if(i)return i.progress}}}const i=await this.templateService.resolveValue(e.target_date);if(!i)return 0;const s=this.dateParser.parseISODate(i),r=Date.now();let n;if(e.creation_date){const t=await this.templateService.resolveValue(e.creation_date);n=t?this.dateParser.parseISODate(t):r}else n=r;const a=s-n;if(a<=0)return 100;const o=r-n,l=Math.min(100,Math.max(0,o/a*100));return this.expired?100:l}getMainDisplay(e,t){if(e.timer_entity&&t){const i=ge.getTimerData(e.timer_entity,t);if(i){const{hours:e,minutes:t,seconds:s}=this.timeRemaining;return i.isAlexaTimer||i.isGoogleTimer?ge.isTimerExpired(i)?{value:"🔔",label:ge.getTimerSubtitle(i,!1)}:e>0?{value:e.toString(),label:1===e?"hour left":"hours left"}:t>0?{value:t.toString(),label:1===t?"minute left":"minutes left"}:{value:s.toString(),label:1===s?"second left":"seconds left"}:e>0?{value:e.toString(),label:1===e?"hour":"hours"}:t>0?{value:t.toString(),label:1===t?"minute":"minutes"}:{value:s.toString(),label:1===s?"second":"seconds"}}}if(!e.timer_entity&&(e.auto_discover_alexa||e.auto_discover_google)&&t){let i=[];if(e.auto_discover_alexa){const e=ge.discoverAlexaTimers(t);i.push(...e)}if(e.auto_discover_google){const e=ge.discoverGoogleTimers(t);i.push(...e)}if(i.length>0){let e=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isActive});if(e||(e=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isPaused})),e){const i=ge.getTimerData(e,t);if(i){this.lastAlexaTimerData=i,this.timeRemaining=this._timerDataToCountdownState(i);const{hours:e,minutes:t,seconds:s}=this.timeRemaining;return ge.isTimerExpired(i)?{value:"🔔",label:ge.getTimerSubtitle(i,!1)}:e>0?{value:e.toString(),label:1===e?"hour left":"hours left"}:t>0?{value:t.toString(),label:1===t?"minute left":"minutes left"}:{value:s.toString(),label:1===s?"second left":"seconds left"}}}if(this.lastAlexaTimerData&&ge.isTimerExpired(this.lastAlexaTimerData))return{value:"🔔",label:ge.getTimerSubtitle(this.lastAlexaTimerData,!1)}}}const{show_months:i,show_days:s,show_hours:r,show_minutes:n,show_seconds:a}=e,{months:o,days:l,hours:c,minutes:d,seconds:h}=this.timeRemaining;return this.expired?e.auto_discover_alexa||e.auto_discover_google?this.lastAlexaTimerData?{value:"🔔",label:ge.getTimerSubtitle(this.lastAlexaTimerData,!1)}:{value:"🔔",label:"Timer complete"}:{value:"🎉",label:"Completed!"}:i&&o>0?{value:o.toString(),label:1===o?"month left":"months left"}:s&&l>0?{value:l.toString(),label:1===l?"day left":"days left"}:r&&c>0?{value:c.toString(),label:1===c?"hour left":"hours left"}:n&&d>0?{value:d.toString(),label:1===d?"minute left":"minutes left"}:a&&h>=0?{value:h.toString(),label:1===h?"second left":"seconds left"}:{value:"0",label:"seconds left"}}getSubtitle(e,t){if(e.timer_entity&&t){const i=ge.getTimerData(e.timer_entity,t);return i?(i.isAlexaTimer||i.isGoogleTimer,ge.getTimerSubtitle(i,!1!==e.show_seconds)):"Timer not found"}if(!e.timer_entity&&(e.auto_discover_alexa||e.auto_discover_google)&&t){let i=[];if(e.auto_discover_alexa&&i.push(...ge.discoverAlexaTimers(t)),e.auto_discover_google&&i.push(...ge.discoverGoogleTimers(t)),i.length>0){let s=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isActive});if(s||(s=i.find(e=>{const i=ge.getTimerData(e,t);return i&&i.isPaused})),s){const i=ge.getTimerData(s,t);if(i)return this.lastAlexaTimerData=i,this.timeRemaining=this._timerDataToCountdownState(i),ge.getTimerSubtitle(i,!1!==e.show_seconds)}if(this.lastAlexaTimerData&&ge.isTimerExpired(this.lastAlexaTimerData))return ge.getTimerSubtitle(this.lastAlexaTimerData,!1!==e.show_seconds);const r=ge.getTimerData(i[0],t);if(r)return ge.getTimerSubtitle(r,!1!==e.show_seconds)}return"No timers found"}if(this.expired){const{expired_text:t="Completed! 🎉"}=e;return t}const{months:i,days:s,hours:r,minutes:n,seconds:a}=this.timeRemaining||{months:0,days:0,hours:0,minutes:0,seconds:0},{show_months:o,show_days:l,show_hours:c,show_minutes:d,show_seconds:h}=e,u=[];if(o&&i>0&&u.push({value:i,unit:1===i?"month":"months"}),l&&s>0&&u.push({value:s,unit:1===s?"day":"days"}),c&&r>0&&u.push({value:r,unit:1===r?"hour":"hours"}),d&&n>0&&u.push({value:n,unit:1===n?"minute":"minutes"}),h&&a>0&&u.push({value:a,unit:1===a?"second":"seconds"}),0===u.length)return h?"0 seconds":"Starting...";if(1===u.length)return`${u[0].value} ${u[0].unit}`;const m=u.map(e=>`${e.value}${e.unit.charAt(0)}`).join(" ");return m}_timerDataToCountdownState(e){return{months:0,days:0,hours:Math.floor(e.remaining/3600),minutes:Math.floor(e.remaining%3600/60),seconds:Math.floor(e.remaining%60),total:1e3*e.remaining}}getTimeRemaining(){return this.timeRemaining}isExpired(){return this.expired}getAvailableAlexaTimers(e){return e?ge.discoverAlexaTimers(e):[]}getAvailableGoogleTimers(e){return e?ge.discoverGoogleTimers(e):[]}getCurrentTimerEntity(e,t){if(e.timer_entity)return e.timer_entity;if((e.auto_discover_alexa||e.auto_discover_google)&&t){let i=[];if(e.auto_discover_alexa){const e=ge.discoverAlexaTimers(t);i.push(...e)}if(e.auto_discover_google){const e=ge.discoverGoogleTimers(t);i.push(...e)}if(i.length>0){for(const e of i){const i=ge.getTimerData(e,t);if(i&&i.isActive)return e}return i[0]}}return null}}class $e{constructor(){this.cache={dynamicIconSize:null,dynamicStrokeWidth:null,customStyles:null,lastConfigHash:null}}processStyles(e){return e&&Array.isArray(e)?e.map(e=>{try{return"string"==typeof e?e:"object"==typeof e&&null!==e?Object.entries(e).map(([e,t])=>`${e}: ${t}`).join("; "):""}catch(t){return""}}).join("; "):""}buildStylesObject(e){const t=JSON.stringify(e.styles||{});if(null!==this.cache.customStyles&&this.cache.lastConfigHash===t)return this.cache.customStyles;const{styles:i={}}=e;try{const e={card:this.processStyles(i.card),title:this.processStyles(i.title),subtitle:this.processStyles(i.subtitle),progress_circle:this.processStyles(i.progress_circle)};return this.cache.customStyles=e,this.cache.lastConfigHash=t,e}catch(s){return this.cache.customStyles={card:"",title:"",subtitle:"",progress_circle:""},this.cache.customStyles}}_getCardDimensions(e,t,i){const s=300,r=150;let n=s,a=r;if(e&&t){n=this.parseDimension(e)||s,a=this.parseDimension(t)||r}else if(e&&i){n=this.parseDimension(e)||s;const[t,r]=i.split("/").map(parseFloat);!isNaN(t)&&!isNaN(r)&&t>0&&(a=n*(r/t))}else if(t&&i){a=this.parseDimension(t)||r;const[e,s]=i.split("/").map(parseFloat);!isNaN(e)&&!isNaN(s)&&s>0&&(n=a*(e/s))}else if(i){const[e,t]=i.split("/").map(parseFloat);!isNaN(e)&&!isNaN(t)&&e>0&&(a=s*(t/e)),n=s}return(!n||isNaN(n)||n<=0)&&(n=s),(!a||isNaN(a)||a<=0)&&(a=r),{cardWidth:n,cardHeight:a}}calculateDynamicIconSize(e,t,i,s){const r=JSON.stringify({width:e,height:t,aspect_ratio:i,icon_size:s});if(null!==this.cache.dynamicIconSize&&this.cache.lastIconConfigHash===r)return this.cache.dynamicIconSize;try{const{cardWidth:n,cardHeight:a}=this._getCardDimensions(e,t,i),o=.4*Math.min(n,a);let l=o;if(s&&"100px"!==s){const e="string"==typeof s?parseInt(s.replace("px","")):"number"==typeof s?s:o;l=isNaN(e)?o:e}return this.cache.dynamicIconSize=Math.max($e.MIN_ICON_SIZE,Math.min(l,$e.MAX_ICON_SIZE)),this.cache.lastIconConfigHash=r,this.cache.dynamicIconSize}catch(n){return this.cache.dynamicIconSize=$e.MIN_ICON_SIZE,this.cache.dynamicIconSize}}calculateDynamicStrokeWidth(e,t){const i=JSON.stringify({iconSize:e,stroke_width:t});if(null!==this.cache.dynamicStrokeWidth&&this.cache.lastStrokeConfigHash===i)return this.cache.dynamicStrokeWidth;try{if(t&&"number"==typeof t)this.cache.dynamicStrokeWidth=Math.max($e.MIN_STROKE,Math.min(t,$e.MAX_STROKE));else{const t=.15,i=Math.round(e*t);this.cache.dynamicStrokeWidth=Math.max($e.MIN_STROKE,Math.min(i,$e.MAX_STROKE))}return this.cache.lastStrokeConfigHash=i,this.cache.dynamicStrokeWidth}catch(s){return this.cache.dynamicStrokeWidth=$e.MIN_STROKE,this.cache.dynamicStrokeWidth}}calculateProportionalSizes(e,t,i){try{const{cardWidth:s,cardHeight:r}=this._getCardDimensions(e,t,i),n=45e3,a=Math.sqrt(s*r/n);return{titleSize:Math.max(1.2,Math.min(2.2,1.6*a)),subtitleSize:Math.max(.9,Math.min(1.4,1.1*a)),cardWidth:s,cardHeight:r}}catch(s){return{titleSize:1.6,subtitleSize:1.1,cardWidth:300,cardHeight:150}}}parseDimension(e){try{if("number"==typeof e)return e;if("string"!=typeof e)return null;const t=e.toLowerCase();if(t.includes("%")){const e=parseFloat(t.replace("%",""));return isNaN(e)?null:e/100*300}if(t.includes("px")){const e=parseFloat(t.replace("px",""));return isNaN(e)?null:e}const i=parseFloat(t);return isNaN(i)?null:i}catch(t){return null}}generateCardDimensionStyles(e,t,i){const s=[];if(e){const t=this._formatDimensionValue(e);t&&s.push(`width: ${t}`)}if(t){const e=this._formatDimensionValue(t);e&&s.push(`height: ${e}`)}else i&&!t&&s.push(`aspect-ratio: ${i}`);return t||i||s.push("min-height: 120px"),s}_formatDimensionValue(e){if(!e)return null;const t=String(e).trim();if(/^[\d.]+\s*(px|%|em|rem|vh|vw|vmin|vmax|ch|ex)$/i.test(t))return t;const i=parseFloat(t);return isNaN(i)?null:`${i}px`}clearCache(){this.cache={dynamicIconSize:null,dynamicStrokeWidth:null,customStyles:null,lastConfigHash:null}}getCardDimensions(e,t,i){return this._getCardDimensions(e,t,i)}}$e.MIN_ICON_SIZE=40,$e.MAX_ICON_SIZE=300,$e.MIN_STROKE=4,$e.MAX_STROKE=50;class be{constructor(e){}get _$AU(){return this._$AM._$AU}_$AT(e,t,i){this._$Ct=e,this._$AM=t,this._$Ci=i}_$AS(e,t){return this.update(e,t)}update(e,t){return this.render(...t)}}const Te=(e,t,i,s)=>{!function(e,t,i){const s=new CustomEvent(t,{bubbles:!0,cancelable:!0,composed:!0,detail:i});e.dispatchEvent(s)}(e,"hass-action",{config:i,action:s})},we=(e,t)=>{const i=(()=>{const e=document.body;if(e.querySelector("action-handler"))return e.querySelector("action-handler");const t=document.createElement("action-handler");return e.appendChild(t),t})();i&&i.bind(e,t)},xe=(e=>(...t)=>({_$litDirective$:e,values:t}))(class extends be{update(e,[t]){return we(e.element,t),W}render(e){return W}});function Se(e){return void 0!==e&&"none"!==e.action}class Ae extends ae{constructor(){super(...arguments),this.errors=[],this.title="Configuration Issues"}static get styles(){return a`
      :host {
        display: block;
        font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif);
      }

      .error-container {
        background: #332022;
        border: 1px solid #582533ff;
        border-radius: 1px;
        padding: 16px;
        margin: 8px;
        color: #ffffff;
      }

      .error-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .error-item {
        margin-bottom: 8px;
        line-height: 1.4;
      }

      .error-field {
        font-weight: 600;
        color: #D74133;
      }
    `}render(){if(!this.errors||0===this.errors.length)return V``;const e=this.errors.filter(e=>"critical"===e.severity||"warning"===e.severity);return 0===e.length?V``:V`
      <div class="error-container">
        <ul class="error-list">
          ${e.map(e=>V`
            <li class="error-item">
              <span class="error-field">${e.field}:</span> ${e.message}
            </li>
          `)}
        </ul>
      </div>
    `}}e([de({type:Array})],Ae.prototype,"errors",void 0),e([de({type:String})],Ae.prototype,"title",void 0),customElements.define("error-display-beta",Ae);class Ce extends ae{static get styles(){return a`
      :host {
        display: block;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        color: var(--primary-text-color, #222);
        --progress-color: var(--progress-color, #4caf50);
      }
      
      /* FIXED: Set initial background immediately to prevent white flash */
      ha-card {
        display: flex;
        flex-direction: column;
        padding: 0;
        border-radius: 22px;
        position: relative;
        overflow: hidden;
        /* IMPORTANT: Set default background immediately */
        background: var(--card-background, var(--primary-background-color, #1a1a1a));
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        border: none;
        /* REMOVED: transition that causes flash - only animate specific properties if needed */
        /* transition: background-color 0.3s ease; */
        min-height: 120px; /* Prevent layout shift */
        user-select: none; /* Prevent text selection during interactions */
      }
      
      /* Make card interactive when actions are configured */
      ha-card[actionHandler] {
        cursor: pointer;
      }
      
      ha-card[actionHandler]:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      
      ha-card[actionHandler]:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      /* Error message styling */
      .error {
        color: #721c24;
        padding: 12px;
        border-radius: 16px;
        white-space: pre-wrap;
        word-break: break-word;
      }
      
      /* FIXED: Only show card after initialization to prevent white flash */
      ha-card:not(.initialized) {
        opacity: 0;
      }
      
      ha-card.initialized {
        opacity: 1;
        transition: opacity 0.2s ease-in;
      }
      
      ha-card.expired {
        animation: celebration 0.8s ease-in-out;
      }
      
      .card-content {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 20px;
        height: 100%;
        /* FIXED: Ensure content has proper background inheritance */
        background: inherit;
      }
      
      .header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0;
      }
      
      .title-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      
      .title {
        font-size: var(--timeflow-title-size, 1.5rem);
        font-weight: 500;
        margin: 0;
        opacity: 0.9;
        line-height: 1.3;
        letter-spacing: -0.01em;
        color: var(--timeflow-card-text-color, inherit);
      }
      
      .subtitle {
        font-size: var(--timeflow-subtitle-size, 1rem);
        opacity: 0.65;
        margin: 0;
        font-weight: 400;
        line-height: 1.2;
        color: var(--timeflow-card-text-color, inherit);
      }
      
      .progress-section {
        flex-shrink: 0;
        margin-left: auto;
      }
      
      .content {
        display: flex;
        align-items: flex-end;
        justify-content: flex-end;
        margin-top: auto;
        padding-top: 12px;
      }
      
      .progress-circle {
        opacity: 0.9;
      }
      
      @keyframes celebration {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }
      
      /* Dark mode support */
      @media (prefers-color-scheme: dark) {
        ha-card {
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
      }
    `}constructor(){super(),this.hass=null,this.config=this.getStubConfig(),this._resolvedConfig=this.getStubConfig(),this._progress=0,this._countdown={months:0,days:0,hours:0,minutes:0,seconds:0,total:0},this._expired=!1,this._validationResult=null,this._initialized=!1,this._timerId=null,this.templateService=new ve,this.countdownService=new ye(this.templateService,fe),this.styleManager=new $e;const e=this.getStubConfig();this.config=e,this._resolvedConfig=e}static getStubConfig(){return{type:"custom:timeflow-card-beta",target_date:"2025-12-31T23:59:59",creation_date:"2024-12-31T23:59:59",timer_entity:"",title:"New Year Countdown",show_days:!0,show_hours:!0,show_minutes:!0,show_seconds:!0,progress_color:"#C0F950",background_color:"#1a1a1a",stroke_width:15,icon_size:100,expired_animation:!0,expired_text:"Completed! 🎉",show_progress_text:!1}}getStubConfig(){return Ce.getStubConfig()}setConfig(e){try{const t=_e.validateConfig(e);if(this._validationResult=t,t.hasCriticalErrors)this.config=t.safeConfig||this.getStubConfig(),this._resolvedConfig={...this.config};else{if(t.hasWarnings)return this.config={...e},this._resolvedConfig={...e},this._initialized=!0,void this.requestUpdate();this.config={...e},this._resolvedConfig={...e}}this._initialized=!1,this.templateService.clearTemplateCache(),this.styleManager.clearCache(),this._updateCountdownAndRender().then(()=>{this._initialized=!0,this.requestUpdate()})}catch(t){this._validationResult={isValid:!1,errors:[{field:"config",message:t.message||"Unexpected configuration error",severity:"critical",suggestion:"Check console for details and verify your configuration syntax.",value:e}],hasCriticalErrors:!0,hasWarnings:!1,safeConfig:this.getStubConfig()},this.config=this.getStubConfig(),this._resolvedConfig={...this.config},this._initialized=!0,this.requestUpdate()}}firstUpdated(){this.templateService.card=this,this._updateCountdownAndRender().then(()=>{this._initialized=!0,this.requestUpdate(),this._startCountdownUpdates()})}disconnectedCallback(){super.disconnectedCallback(),this._stopCountdownUpdates()}updated(e){(e.has("hass")||e.has("config"))&&(this.templateService.clearTemplateCache(),this._updateCountdownAndRender())}_startCountdownUpdates(){this._stopCountdownUpdates(),this._timerId=setInterval(()=>{this._updateCountdownAndRender()},1e3)}_stopCountdownUpdates(){this._timerId&&(clearInterval(this._timerId),this._timerId=null)}async _updateCountdownAndRender(){var e;if(null===(e=this._validationResult)||void 0===e?void 0:e.hasCriticalErrors)return;const t={...this.config},i=["target_date","creation_date","timer_entity","title","subtitle","color","background_color","progress_color","primary_color","secondary_color","expired_text"];for(const s of i)if("string"==typeof t[s]&&this.templateService.isTemplate(t[s])){const e=await this.templateService.resolveValue(t[s]);t[s]=e||void 0}this._resolvedConfig=t,await this.countdownService.updateCountdown(t,this.hass),this._countdown={...this.countdownService.getTimeRemaining()},this._expired=this.countdownService.isExpired(),this._progress=await this.countdownService.calculateProgress(t,this.hass),this.requestUpdate()}render(){return this._validationResult&&!this._validationResult.isValid?V`
        <error-display-beta
          .errors="${this._validationResult.errors}"
          .title="${this._validationResult.hasCriticalErrors?"Configuration Error":"Configuration Issues"}"
        ></error-display-beta>
      `:this._renderCard()}_renderCard(){var e;const{title:t,subtitle:i,color:s,background_color:r,progress_color:n,stroke_width:a,icon_size:o,expired_animation:l=!0,expired_text:c="Completed! 🎉",width:d,height:h,aspect_ratio:u,show_progress_text:m=!1}=this._resolvedConfig,p=r||"var(--card-background, var(--primary-background-color, #1a1a1a))",g=s||"var(--primary-text-color, #fff)",f=n||s||"var(--progress-color, #4caf50)",_=this.styleManager.calculateDynamicIconSize(d,h,u,o),v=this.styleManager.calculateDynamicStrokeWidth(_,a),y=this.styleManager.calculateProportionalSizes(d,h,u),$=this.styleManager.generateCardDimensionStyles(d,h,u),b=[`background: ${p}`,`color: ${g}`,`--timeflow-card-background-color: ${p}`,`--timeflow-card-text-color: ${g}`,`--timeflow-card-progress-color: ${f}`,`--timeflow-card-icon-size: ${_}px`,`--timeflow-card-stroke-width: ${v}`,`--timeflow-title-size: ${y.titleSize}rem`,`--timeflow-subtitle-size: ${y.subtitleSize}rem`,`--progress-text-color: ${g}`,...$].join("; ");let T;if(this._resolvedConfig.timer_entity&&this.hass){const e=ge.getTimerData(this._resolvedConfig.timer_entity,this.hass);T=e?this._expired&&(e.isAlexaTimer||e.isGoogleTimer)?ge.getTimerSubtitle(e,!1!==this._resolvedConfig.show_seconds):this._expired?c:i||ge.getTimerSubtitle(e,!1!==this._resolvedConfig.show_seconds):this._expired?c:i||this.countdownService.getSubtitle(this._resolvedConfig,this.hass)}else T=this._resolvedConfig.auto_discover_alexa?i||this.countdownService.getSubtitle(this._resolvedConfig,this.hass):this._expired?c:i||this.countdownService.getSubtitle(this._resolvedConfig,this.hass);let w=t;(null==w||"string"==typeof w&&""===w.trim())&&(w=this._resolvedConfig.timer_entity&&this.hass?ge.getTimerTitle(this._resolvedConfig.timer_entity,this.hass):this._resolvedConfig.auto_discover_alexa||this._resolvedConfig.auto_discover_google?"Countdown Timer":this._expired?c:"Countdown Timer");const x=[this._initialized?"initialized":"",this._expired&&l?"expired":""].filter(Boolean).join(" "),S={...this._resolvedConfig};S.timer_entity&&!S.entity&&(S.entity=S.timer_entity),S.entity&&!S.tap_action&&(S.tap_action={action:"more-info"}),null===(e=S.tap_action)||void 0===e||e.action;const A=S.tap_action||S.hold_action||S.double_tap_action;return V`
      <ha-card 
        class="${x}" 
        style="${b}"
        ?actionHandler=${A}
        .actionHandler=${A?(C=S,xe({hasHold:Se(C.hold_action),hasDoubleClick:Se(C.double_tap_action)})):void 0}
        @action=${A&&this.hass?function(e,t){return e=>{Te(e.target,0,t,e.detail.action)}}(this.hass,S):void 0}
      >
        <div class="card-content">
          <header class="header">
            <div class="title-section">
              <h2 class="title" aria-live="polite">${w}</h2>
              <p class="subtitle" aria-live="polite">${T}</p>
            </div>
          </header>
          
          <div class="content" role="group" aria-label="Countdown Progress">
            <div class="progress-section">
              <progress-circle-beta
                class="progress-circle"
                .progress="${this._progress}"
                .color="${f}"
                .size="${_}"
                .strokeWidth="${v}"
                .showProgressText="${!0===m}"
                aria-label="Countdown progress: ${Math.round(this._progress)}%"
              ></progress-circle-beta>
            </div>
          </div>
        </div>
      </ha-card>
    `;var C}getCardSize(){const{aspect_ratio:e="2/1",height:t}=this.config;if(t){const e=parseInt("string"==typeof t?t:t.toString());return e<=100?1:e<=150?2:e<=200?3:4}if(e){const[t,i]=e.split("/").map(Number);if(!t||!i)return 3;const s=i/t;return s>=1.5?4:s>=1?3:2}return 3}static get version(){return"1.2.0-lit"}}e([de({type:Object})],Ce.prototype,"hass",void 0),e([de({type:Object})],Ce.prototype,"config",void 0),e([he()],Ce.prototype,"_resolvedConfig",void 0),e([he()],Ce.prototype,"_progress",void 0),e([he()],Ce.prototype,"_countdown",void 0),e([he()],Ce.prototype,"_expired",void 0),e([he()],Ce.prototype,"_validationResult",void 0),e([he()],Ce.prototype,"_initialized",void 0);class De extends ae{static get styles(){return a`
      :host {
        display: inline-block;
        vertical-align: middle;
      }
      .progress-wrapper {
        position: relative;
      }
      svg {
        display: block;
        margin: 0 auto;
      }
      .progress-text {
        font-size: 16px;  
        font-weight: bold;
        fill: var(--progress-text-color, #f4f5f4ff);
        dominant-baseline: middle;
        text-anchor: middle;
        pointer-events: none;
        user-select: none;
      }
      .updating {
        transition: stroke-dashoffset 0.3s ease;
      }
    `}constructor(){super(),this.progress=0,this.color="#4CAF50",this.size=100,this.strokeWidth=15,this.showProgressText=!1,this.progress=0,this.color="#4CAF50",this.size=100,this.strokeWidth=15,this.showProgressText=!1}updated(e){var t;if(e.has("progress")){const e=null===(t=this.renderRoot)||void 0===t?void 0:t.querySelector(".progress-bar");e&&(e.classList.add("updating"),setTimeout(()=>{e&&e.classList.remove("updating")},400))}}updateProgress(e,t=!0){var i;if(t)this.progress=e;else{const t=null===(i=this.renderRoot)||void 0===i?void 0:i.querySelector(".progress-bar");this.progress=e,t&&(t.style.transition="none"),setTimeout(()=>{t&&(t.style.transition="")},20)}}getProgress(){return this.progress}render(){const e=Math.max(0,Math.min(100,Number(this.progress)||0)),t=Number(this.size)||100,i=Number(this.strokeWidth)||15,s=(t-i)/2,r=2*Math.PI*s,n=r-e/100*r,a=Math.max(10,Math.min(24,.16*t));return V`
      <div class="progress-wrapper" style="width:${t}px; height:${t}px;">
        <svg
          class="progress-circle-beta"
          height="${t}" width="${t}"
          style="overflow:visible;"
        >
          <circle
            class="progress-bg"
            cx="${t/2}" cy="${t/2}"
            r="${s}"
            fill="none"
            stroke="#FFFFFF1A"
            stroke-width="${i}"
          ></circle>
          <circle
            class="progress-bar"
            cx="${t/2}" cy="${t/2}"
            r="${s}"
            fill="none"
            stroke="${this.color}"
            stroke-width="${i}"
            stroke-linecap="round"
            style="
              stroke-dasharray: ${r};
              stroke-dashoffset: ${n};
              transition: stroke-dashoffset 0.3s ease;
              transform: rotate(-90deg);
              transform-origin: ${t/2}px ${t/2}px;
            "
          ></circle>

          ${this.showProgressText?V`
                <text
                  x="50%" y="50%"
                  class="progress-text"
                  dy="2"
                  style="font-size: ${a}px;"
                >
                  ${Math.round(e)}%
                </text>
              `:V`<!-- showProgressText is false -->`}
        </svg>
      </div>
    `}}e([de({type:Number})],De.prototype,"progress",void 0),e([de({type:String})],De.prototype,"color",void 0),e([de({type:Number})],De.prototype,"size",void 0),e([de({type:Number})],De.prototype,"strokeWidth",void 0),e([de({type:Boolean})],De.prototype,"showProgressText",void 0),customElements.get("error-display-beta")||customElements.define("error-display-beta",Ae),customElements.get("progress-circle-beta")||customElements.define("progress-circle-beta",De),customElements.get("timeflow-card-beta")||customElements.define("timeflow-card-beta",Ce),window.customCards=window.customCards||[],window.customCards.push({type:"timeflow-card-beta",name:"TimeFlow Card (Lit Version)",description:"A beautiful countdown timer card with progress circle for Home Assistant, using Lit",preview:!0,documentationURL:"https://github.com/Rishi8078/TimeFlow-Card"});export{Ae as ErrorDisplayBeta,De as ProgressCircleBeta,Ce as TimeFlowCardBeta};
